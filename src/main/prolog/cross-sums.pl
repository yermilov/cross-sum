cross_sum(X_CONSTRAINTS, Y_CONSTRAINTS, POSITION) :- 
	generate_all_positions(X_CONSTRAINTS, Y_CONSTRAINTS, ALL_POSITIONS),
	generate_next_position(ALL_POSITIONS, POSITION),
	format('~n~w~n', [POSITION]),
	fit_vertical_constraints(Y_CONSTRAINTS, POSITION).

generate_all_positions([_ | X_CONSTRAINTS_TAIL], [_ | Y_CONSTRAINTS_TAIL], ALL_POSITIONS) :- do_generate_all_positions(X_CONSTRAINTS_TAIL, Y_CONSTRAINTS_TAIL,  ALL_POSITIONS).

do_generate_all_positions([], [], []).
do_generate_all_positions([X_CONSTRAINTS_HEAD | X_CONSTRAINTS_TAIL], [Y_CONSTRAINTS_HEAD | Y_CONSTRAINTS_TAIL], [ALL_POSITIONS_HEAD | ALL_POSITIONS_TAIL]) :-
	list_of_one(X_CONSTRAINTS_HEAD, FIRST_POSITION_LINE),
	generate_all_positions_for_one_line(X_CONSTRAINTS_HEAD, Y_CONSTRAINTS_HEAD, FIRST_POSITION_LINE, ALL_POSITIONS_HEAD),
	do_generate_all_positions(X_CONSTRAINTS_TAIL, Y_CONSTRAINTS_TAIL, ALL_POSITIONS_TAIL).

generate_all_positions_for_one_line(X_CONSTRAINT_LINE, Y_CONSTRAINT_LINE, FIRST_POSITION_LINE, [POSITION_LINE | ALL_POSITIONS_LINE_TAIL]) :- 
	iterate_following_list(FIRST_POSITION_LINE, POSITION_LINE, X_CONSTRAINT_LINE, Y_CONSTRAINT_LINE),
	fit_one_line_constraints(X_CONSTRAINT_LINE, POSITION_LINE),
	format('~n~w~n', [POSITION_LINE]),
	generate_all_positions_for_one_line(X_CONSTRAINT_LINE, Y_CONSTRAINT_LINE, POSITION_LINE, ALL_POSITIONS_LINE_TAIL).
generate_all_positions_for_one_line(_, _, _, []).

generate_next_position([], []).
generate_next_position([ALL_POSITIONS_HEAD | ALL_POSITIONS_TAIL], [ONE_LINE_POSITION | POSITION_TAIL]) :- 
	generate_one_line_position(ALL_POSITIONS_HEAD, ONE_LINE_POSITION),
	generate_next_position(ALL_POSITIONS_TAIL, POSITION_TAIL).
	
generate_one_line_position([ALL_POSITIONS_LINE_HEAD | _], ALL_POSITIONS_LINE_HEAD).
generate_one_line_position([_ | ALL_POSITIONS_LINE_TAIL], ONE_LINE_POSITION) :- generate_one_line_position(ALL_POSITIONS_LINE_TAIL, ONE_LINE_POSITION).
	
list_of_one([_ | TAIL], LIST_OF_ONE) :- do_list_of_one(TAIL, LIST_OF_ONE).
	
do_list_of_one([], []).
do_list_of_one([_ | TAIL], [1 | LIST]) :- do_list_of_one(TAIL, LIST).

iterate_following_list(FIRST_LIST, FOLLOWING_LIST, CONSTRAINT_LINE_1, CONSTRAINT_LINE_2) :- following_list(CONSTRAINT_LINE_1, CONSTRAINT_LINE_2, FIRST_LIST, FOLLOWING_LIST).
iterate_following_list(FIRST_LIST, FOLLOWING_LIST, CONSTRAINT_LINE_1, CONSTRAINT_LINE_2) :- 
	following_list(CONSTRAINT_LINE_1, CONSTRAINT_LINE_2, FIRST_LIST, ITERATE_LIST), iterate_following_list(ITERATE_LIST, FOLLOWING_LIST, CONSTRAINT_LINE_1, CONSTRAINT_LINE_2).

following_list([_ | CONSTRAINT_LINE_1_TAIL], [_ | CONSTRAINT_LINE_2_TAIL], LIST, FOLLOWING_TAIL) :- 
	do_following_list(CONSTRAINT_LINE_1_TAIL, CONSTRAINT_LINE_2_TAIL, LIST, FOLLOWING_TAIL).
	
do_following_list(_, _, [], []) :- false.
do_following_list([CONSTRAINT_LINE_1_HEAD | CONSTRAINT_LINE_1_TAIL], [CONSTRAINT_LINE_2_HEAD | CONSTRAINT_LINE_2_TAIL], [_ | LIST_TAIL], [0 | FOLLOWING_TAIL]) :- 
	CONSTRAINT_LINE_1_HEAD =\= 0, CONSTRAINT_LINE_2_HEAD = 0, do_following_list(CONSTRAINT_LINE_1_TAIL, CONSTRAINT_LINE_2_TAIL, LIST_TAIL, FOLLOWING_TAIL).
do_following_list([CONSTRAINT_LINE_1_HEAD | CONSTRAINT_LINE_1_TAIL], [CONSTRAINT_LINE_2_HEAD | CONSTRAINT_LINE_2_TAIL], [_ | LIST_TAIL], [0 | FOLLOWING_TAIL]) :- 
	CONSTRAINT_LINE_1_HEAD = 0, CONSTRAINT_LINE_2_HEAD =\= 0, do_following_list(CONSTRAINT_LINE_1_TAIL, CONSTRAINT_LINE_2_TAIL, LIST_TAIL, FOLLOWING_TAIL).
do_following_list([CONSTRAINT_LINE_1_HEAD | CONSTRAINT_LINE_1_TAIL], [CONSTRAINT_LINE_2_HEAD | CONSTRAINT_LINE_2_TAIL], [_ | LIST_TAIL], [0 | FOLLOWING_TAIL]) :- 
	CONSTRAINT_LINE_1_HEAD =\= 0, CONSTRAINT_LINE_2_HEAD =\= 0, do_following_list(CONSTRAINT_LINE_1_TAIL, CONSTRAINT_LINE_2_TAIL, LIST_TAIL, FOLLOWING_TAIL).
do_following_list([CONSTRAINT_LINE_1_HEAD | CONSTRAINT_LINE_1_TAIL], [CONSTRAINT_LINE_2_HEAD | CONSTRAINT_LINE_2_TAIL], [9 | LIST_TAIL], [1 | FOLLOWING_TAIL]) :- 
	CONSTRAINT_LINE_1_HEAD = 0, CONSTRAINT_LINE_2_HEAD = 0, do_following_list(CONSTRAINT_LINE_1_TAIL, CONSTRAINT_LINE_2_TAIL, LIST_TAIL, FOLLOWING_TAIL).
do_following_list([CONSTRAINT_LINE_1_HEAD | _], [CONSTRAINT_LINE_2_HEAD | _], [LIST_HEAD | LIST_TAIL], [FOLLOWING_HEAD | LIST_TAIL]) :- 
	CONSTRAINT_LINE_1_HEAD = 0, CONSTRAINT_LINE_2_HEAD = 0, LIST_HEAD < 9, FOLLOWING_HEAD is LIST_HEAD + 1.

fit_one_line_constraints([CONSTRAINTS_LINE_HEAD | CONSTRAINTS_LINE_TAIL], POSITON_LINE) :- 
	CONSTRAINTS_LINE_HEAD > 0, is_fit_one_line_constraints(CONSTRAINTS_LINE_TAIL, POSITON_LINE, CONSTRAINTS_LINE_HEAD, []).
fit_one_line_constraints([CONSTRAINTS_LINE_HEAD | CONSTRAINTS_LINE_TAIL], POSITON_LINE) :- 
	CONSTRAINTS_LINE_HEAD =< 0, skip_one_line_constraints(CONSTRAINTS_LINE_TAIL, POSITON_LINE, []).

is_fit_one_line_constraints([], [], 0, _).
is_fit_one_line_constraints([CONSTRAINTS_LINE_HEAD | CONSTRAINTS_LINE_TAIL], [_ | POSITON_LINE_TAIL], POINTS_LEFT, _) :- 
	CONSTRAINTS_LINE_HEAD > 0, POINTS_LEFT = 0, 
	is_fit_one_line_constraints(CONSTRAINTS_LINE_TAIL, POSITON_LINE_TAIL, CONSTRAINTS_LINE_HEAD, []).
is_fit_one_line_constraints([CONSTRAINTS_LINE_HEAD | CONSTRAINTS_LINE_TAIL], [_ | POSITON_LINE_TAIL], POINTS_LEFT, _) :- 
	CONSTRAINTS_LINE_HEAD < 0, POINTS_LEFT = 0, 
	skip_one_line_constraints(CONSTRAINTS_LINE_TAIL, POSITON_LINE_TAIL, []).
is_fit_one_line_constraints([CONSTRAINTS_LINE_HEAD | CONSTRAINTS_LINE_TAIL], [POSITON_LINE_HEAD | POSITON_LINE_TAIL], POINTS_LEFT, USED_NUMBERS) :- 
	CONSTRAINTS_LINE_HEAD = 0, POINTS_LEFT >= 0, not_contains(POSITON_LINE_HEAD, USED_NUMBERS), NEW_POINTS_LEFT is POINTS_LEFT - POSITON_LINE_HEAD, 
	is_fit_one_line_constraints(CONSTRAINTS_LINE_TAIL, POSITON_LINE_TAIL, NEW_POINTS_LEFT, [POSITON_LINE_HEAD | USED_NUMBERS]).
	
skip_one_line_constraints([], [], _).
skip_one_line_constraints([CONSTRAINTS_LINE_HEAD | CONSTRAINTS_LINE_TAIL], [_ | POSITON_LINE_TAIL], _) :- 
	CONSTRAINTS_LINE_HEAD > 0, is_fit_one_line_constraints(CONSTRAINTS_LINE_TAIL, POSITON_LINE_TAIL, CONSTRAINTS_LINE_HEAD, []).
skip_one_line_constraints([CONSTRAINTS_LINE_HEAD | CONSTRAINTS_LINE_TAIL], [_ | POSITON_LINE_TAIL], _) :- 
	CONSTRAINTS_LINE_HEAD < 0, skip_one_line_constraints(CONSTRAINTS_LINE_TAIL, POSITON_LINE_TAIL, []).
skip_one_line_constraints([CONSTRAINTS_LINE_HEAD | CONSTRAINTS_LINE_TAIL], [POSITON_LINE_HEAD | POSITON_LINE_TAIL], USED_NUMBERS) :- 
	CONSTRAINTS_LINE_HEAD = 0, not_contains(POSITON_LINE_HEAD, USED_NUMBERS), skip_one_line_constraints(CONSTRAINTS_LINE_TAIL, POSITON_LINE_TAIL, [POSITON_LINE_HEAD | USED_NUMBERS]).

not_contains(_, []).
not_contains(ELEMENT, [ELEMENT | _]) :- false.
not_contains(ELEMENT, [LIST_HEAD | LIST_TAIL]) :- LIST_HEAD =\= ELEMENT, not_contains(ELEMENT, LIST_TAIL).

fit_vertical_constraints([[_ | Y_CONSTRAINTS_HEAD] | Y_CONSTRAINTS_TAIL], POSITION) :- 
	generate_empty_list_list(POSITION, EMPTY_LIST_LIST),
	is_fit_vertical_constraints(Y_CONSTRAINTS_TAIL, POSITION, Y_CONSTRAINTS_HEAD, EMPTY_LIST_LIST, Y_CONSTRAINTS_HEAD).

is_fit_vertical_constraints([], [], POINTS_LEFT_LIST, _, SKIP_LIST) :- all_zeros(POINTS_LEFT_LIST, SKIP_LIST).
is_fit_vertical_constraints([CONSTRAINTS_HEAD | CONSTRAINTS_TAIL], [POSITION_HEAD | POSITION_TAIL], POINTS_LEFT_LIST, USED_NUMBERS_LIST, SKIP_LIST) :- 
	process_vertical_constraints(CONSTRAINTS_HEAD, POSITION_HEAD, POINTS_LEFT_LIST, USED_NUMBERS_LIST, SKIP_LIST, NEW_POINTS_LEFT_LIST, NEW_USED_NUMBERS_LIST, NEW_SKIP_LIST),
	is_fit_vertical_constraints(CONSTRAINTS_TAIL, POSITION_TAIL, NEW_POINTS_LEFT_LIST, NEW_USED_NUMBERS_LIST, NEW_SKIP_LIST).

process_vertical_constraints([_ | CONSTRAINTS_LINE_TAIL], POSITION_HEAD, POINTS_LEFT_LIST, USED_NUMBERS_LIST, SKIP_LIST, NEW_POINTS_LEFT_LIST, NEW_USED_NUMBERS_LIST, NEW_SKIP_LIST) :- 
	do_process_vertical_constraints(CONSTRAINTS_LINE_TAIL, POSITION_HEAD, POINTS_LEFT_LIST, USED_NUMBERS_LIST, SKIP_LIST, NEW_POINTS_LEFT_LIST, NEW_USED_NUMBERS_LIST, NEW_SKIP_LIST).
	
do_process_vertical_constraints([], [], _, _, _, [], [], []).
do_process_vertical_constraints(
		[CONSTRAINTS_LINE_HEAD | CONSTRAINTS_LINE_TAIL], 
		[_ | POSITON_LINE_TAIL], 
		[POINTS_LEFT_HEAD | POINTS_LEFT_TAIL], 
		[_ | USER_NUMBERS_TAIL], 
		[SKIP_LIST_HEAD | SKIP_LIST_TAIL],
		[CONSTRAINTS_LINE_HEAD | NEW_POINTS_LEFT_LIST], 
		[[] | NEW_USED_NUMBERS_LIST],
		[CONSTRAINTS_LINE_HEAD | NEW_SKIP_LIST_TAIL]
	) :- 
	CONSTRAINTS_LINE_HEAD =\= 0, SKIP_LIST_HEAD > 0,
	POINTS_LEFT_HEAD = 0,
	do_process_vertical_constraints(CONSTRAINTS_LINE_TAIL, POSITON_LINE_TAIL, POINTS_LEFT_TAIL, USER_NUMBERS_TAIL, SKIP_LIST_TAIL, NEW_POINTS_LEFT_LIST, NEW_USED_NUMBERS_LIST, NEW_SKIP_LIST_TAIL).
do_process_vertical_constraints(
		[CONSTRAINTS_LINE_HEAD | CONSTRAINTS_LINE_TAIL], 
		[_ | POSITON_LINE_TAIL], 
		[_ | POINTS_LEFT_TAIL], 
		[_ | USER_NUMBERS_TAIL], 
		[SKIP_LIST_HEAD | SKIP_LIST_TAIL],
		[CONSTRAINTS_LINE_HEAD | NEW_POINTS_LEFT_LIST], 
		[[] | NEW_USED_NUMBERS_LIST],
		[CONSTRAINTS_LINE_HEAD | NEW_SKIP_LIST_TAIL]
	) :- 
	CONSTRAINTS_LINE_HEAD =\= 0, SKIP_LIST_HEAD =< 0,
	do_process_vertical_constraints(CONSTRAINTS_LINE_TAIL, POSITON_LINE_TAIL, POINTS_LEFT_TAIL, USER_NUMBERS_TAIL, SKIP_LIST_TAIL, NEW_POINTS_LEFT_LIST, NEW_USED_NUMBERS_LIST, NEW_SKIP_LIST_TAIL).
do_process_vertical_constraints(
		[CONSTRAINTS_LINE_HEAD | CONSTRAINTS_LINE_TAIL], 
		[POSITON_LINE_HEAD | POSITON_LINE_TAIL], 
		[POINTS_LEFT_HEAD | POINTS_LEFT_TAIL], 
		[USED_NUMBERS_HEAD | USER_NUMBERS_TAIL], 
		[SKIP_LIST_HEAD | SKIP_LIST_TAIL],
		[NEW_POINTS_LEFT_HEAD | NEW_POINTS_LEFT_LIST], 
		[[POSITON_LINE_HEAD | USED_NUMBERS_HEAD] | NEW_USED_NUMBERS_LIST],
		[SKIP_LIST_HEAD | NEW_SKIP_LIST_TAIL]
	) :- 
	CONSTRAINTS_LINE_HEAD = 0, SKIP_LIST_HEAD > 0,
	POINTS_LEFT_HEAD >= 0, not_contains(POSITON_LINE_HEAD, USED_NUMBERS_HEAD), NEW_POINTS_LEFT_HEAD is POINTS_LEFT_HEAD - POSITON_LINE_HEAD,
	do_process_vertical_constraints(CONSTRAINTS_LINE_TAIL, POSITON_LINE_TAIL, POINTS_LEFT_TAIL, USER_NUMBERS_TAIL, SKIP_LIST_TAIL, NEW_POINTS_LEFT_LIST, NEW_USED_NUMBERS_LIST, NEW_SKIP_LIST_TAIL).
do_process_vertical_constraints(
		[CONSTRAINTS_LINE_HEAD | CONSTRAINTS_LINE_TAIL], 
		[POSITON_LINE_HEAD | POSITON_LINE_TAIL], 
		[POINTS_LEFT_HEAD | POINTS_LEFT_TAIL], 
		[USED_NUMBERS_HEAD | USER_NUMBERS_TAIL], 
		[SKIP_LIST_HEAD | SKIP_LIST_TAIL],
		[NEW_POINTS_LEFT_HEAD | NEW_POINTS_LEFT_LIST], 
		[[POSITON_LINE_HEAD | USED_NUMBERS_HEAD] | NEW_USED_NUMBERS_LIST],
		[SKIP_LIST_HEAD | NEW_SKIP_LIST_TAIL]
	) :- 
	CONSTRAINTS_LINE_HEAD = 0, SKIP_LIST_HEAD =< 0,
	not_contains(POSITON_LINE_HEAD, USED_NUMBERS_HEAD),
	NEW_POINTS_LEFT_HEAD is POINTS_LEFT_HEAD - POSITON_LINE_HEAD,
	do_process_vertical_constraints(CONSTRAINTS_LINE_TAIL, POSITON_LINE_TAIL, POINTS_LEFT_TAIL, USER_NUMBERS_TAIL, SKIP_LIST_TAIL, NEW_POINTS_LEFT_LIST, NEW_USED_NUMBERS_LIST, NEW_SKIP_LIST_TAIL).
	
generate_empty_list_list([], []).
generate_empty_list_list([_ | TAIL], [[] | LIST]) :- generate_empty_list_list(TAIL, LIST).

all_zeros([], []).
all_zeros([0 | TAIL], [SKIP_LIST_HEAD | SKIP_LIST_TAIL]) :- SKIP_LIST_HEAD > 0, all_zeros(TAIL, SKIP_LIST_TAIL).
all_zeros([_ | TAIL], [SKIP_LIST_HEAD | SKIP_LIST_TAIL]) :- SKIP_LIST_HEAD =< 0, all_zeros(TAIL, SKIP_LIST_TAIL).